<html>
  <head><title>RESTful API for the use by the Rule Game client - second batch</title>
  </head>
<body>
  <h1>RESTful API for the use by the Rule Game client - second batch</h1>

  <p align="center"><em>Version 1.022,  2020-09-20</em></p>

  <p>This is the "Second Batch" (prefix=<tt>/GameService2</tt>)  of the Game Service web API calls. They are intended for use with a client app that works with players enrolled in experiments; each player is identified by a player ID, and the server assigns each player to a "trial list" (a particular track in the experiment plan with which this player ID is associated with).</p>

  <p>For calls used by players not enrolled in experiments (e.g. our own team members developing and testing games), see <a href="game-api.html">the First Batch</a>.</P>
    
  
  <ol>
<li>POST <strong><tt>/player:</tt> Start a player's interaction with the system, and obtain a randomly selected trial list for this player</strong>
  <form method="post" action="game-data/GameService2/player"
	 enctype="application/x-www-form-urlencoded">
     Player ID: <input name="playerId" type="text" size="25" value="AnyText01">
	  <input type="submit">
  </form>
  <p>The input parameter is the player ID (a string). In the future, the system will determine, based on the player ID, what experiment the person is enrolled into (e.g MTurkers vs. psych students vs. ourselves testing a particular game); at present, the player ID does not really matter, as everybody is considered to be enrolled in the experiment called "default".</P>

  <p>For the meaning of the output fields, see the documentation for <a href="api/edu/wisc/game/rest/PlayerResponse.html">PlayerResponse</a>. A field named <tt>foo</tt> will be described there under <tt>getFoo()</tt> or (for boolean values) <tt>isFoo()</tt>.

    <p>Ver. 1.021: added <tt>trialList</tt>, which is a vector with one element per line of the trial list. Can be used to find the total number of rule sets to which a player will be exposed.</p>
    
  <p>Sample output:
    <pre>
      {"errmsg":"Debug:...",
      "error":false,
      "newlyRegistered":false,
      "trialListId":"trial_1"}
    </pre>
    
    In practice, you don't need any of the returned values, other than the error code.</p></li>

<li>POST <strong><tt>/mostRecentEpisode</tt>: Return the latest episode (complete or incomplete) for a specified user:</strong>
        <form method="post" action="game-data/GameService2/mostRecentEpisode"
	 enctype="application/x-www-form-urlencoded">
	  Player ID: <input name="playerId" type="text" value="" size="20"><br>
	  <input type="submit">
	</form>

  <P>The response is in the same format as for /newEpisode, below. Check the values of <tt>display.<a href="api/constant-values.html">finishCode</a></tt> to see the status of the game (continuing/cleared/stalemated/given up), and of <tt>display.guessSaved</tt> to see if a guess has been recorded.</p> 

<li>POST <strong><tt>/newEpisode</tt>: Create a new episode for a specified user:</strong>
        <form method="post" action="game-data/GameService2/newEpisode"
	 enctype="application/x-www-form-urlencoded">
	  Player ID: <input name="playerId" type="text" value="" size="20"><br>
	  Optional parameters (to effect certain preliminary actions before
	  the /newEpisode call):
	  <br>
	  Activate Bonus: 	  <select name="activateBonus">
	    <option value="true">true</option>
	    <option value="false" selected>false</option>
	  </select> (If true, the /activateBonus operation will be executed immediately prior to the new episode retrieval)
	  <br>
	  Give up: 	  <select name="giveUp">
	    <option value="true">true</option>
	    <option value="false" selected>false</option>
	  </select> (If true, the /giveUp operation will be executed immediately prior to the new episode retrieval)	  
	  <input type="submit">
	</form>

<p>For the meaning of the output fields, see the documentation for <a href="api/edu/wisc/game/rest/NewEpisodeWrapper2.html">NewEpisodeWrapper2</a>. A field named <tt>foo</tt> will be described there under <tt>getFoo()</tt> or (for boolean values) <tt>isFoo()</tt>.
	
  <p>Sample output (in ver. 1.014); note that some fields have been moved from X to display.X. The fields within display.{...} are the same as those given by the /display and /move calls.	
	<pre>
	  {"errmsg":"Debug:...",
	  "error":false,
	  "alreadyFinished":false,
	  "display":{
	  "board":{"id":0,"value":[{"buckets":[3],"color":"BLUE","id":1,"shape":"SQUARE","x":5,"y":5}]},"code":-8,"errmsg":"Display requested\nDEBUG\n[0][20200827-153052-F66ITP; FC=1; M 2/2 $10][20200827-153246-R7LHH9; FC=1; M 3/3 $10]\n[1][20200827-160602-PYQTAJ; FC=1; M 2/2 $10][20200827-162713-2HRENR; FC=1; M 2/2 $10]\n*M*[2][20200905-120700-PDF966; FC=1; M 1/1 $10][20200905-121136-7L3EHY; FC=0; M 0/1 $0]\nR=$50",
	  "finishCode":0,
	  "numMovesMade":1,
	  "bonus":false,
	  "bonusEpisodeNo":0,
	  "canActivateBonus":true,
	  "episodeNo":1,
	  "guessSaved":false,
	  "seriesNo":2,
	  "totalBoardsPredicted":2,
	  "totalRewardEarned":50
	  "transcript":[{"pos":32,"bucketNo":3,"code":0}]} // <em>All moves (and move attempts) - new in ver 1.014</em>
	  },
	  "episodeId":"20200905-121136-7L3EHY",
	  "para":{"clearing_threshold":1.3,"max_points":10,"b":1.5,"min_points":2,"max_colors":1,"f":4,"feedback_switches":"fixed","min_objects":1,"m":9,"n":1,"clear_how_many":2,"bonus_extra_pts":3,"rule_id":"TD-03","max_objects":3,"grid_memory_show_order":false,"min_shapes":1,"stack_memory_show_order":false,"max_shapes":1,"min_colors":1,"stack_memory_depth":6,"max_boards":2,"activate_bonus_at":2}}  
	</pre>

<p>display.transcript contains the description of all previous moves, as a vector. Each element has pos=the origin position (as an integer, numbered from 1=(1,1) to 36=(6,6), by row from left bottom corner), bucketNo=the destination bucket number, and the success code (same meaning as display.code)
	
 <br>Sample output (in ver. 1.011)
<pre>
	
<pre>
  {"errmsg":"Debug...", <em> // either used to describe errors, or contains various status info for debugging.</em>
  "error":false,   <em> // true if something bad has happened</em>
  "alreadyFinished":false,  <em> // this will be true if error==true, and the error is caused by the fact that the player has already done all his param sets</em>
 "board":{"longId":0,"id":0,"value":
[{"buckets":[0],"color":"RED","id":0,"shape":"STAR","x":3,"y":1},
{"buckets":[0],"color":"RED","id":0,"shape":"STAR","x":3,"y":5}]},
<em> // description of the initial board </em>
"bonus":false,    <em> // true if this episode is part of a bonus subseries</em>
"bonusEpisodeNo":0, <em> // the number of previous bonus episodes in this series</em>
"canActivateBonus":false, <em> // true if you can put an "Activate Bonus" button on the screen in this episode</em>
"episodeId":"20200828-021427-FJRX9J",<em> // Save this and use it in /move calls later!</em>
"para":
{"clearing_threshold":1.3,"max_points":10,"b":1.5,"min_points":2,
"max_colors":1,"f":4,"feedback_switches":"fixed","min_objects":1,"m":9,"n":1,
"clear_how_many":2,"bonus_extra_pts":3,"rule_id":"TD-02","max_objects":3,
"grid_memory_show_order":false,"min_shapes":1,"stack_memory_show_order":false,
"max_shapes":1,"min_colors":1,"stack_memory_depth":6,"max_boards":2,
"activate_bonus_at":2},
<em> // All the parameters from the current param set
  //  (the current row of the trial list file). Some of them may be used by the
//GUI tool to control some points of the appearance </em>
"seriesNo":1, <em> // the 0-based sequential number of this series (= 0-based sequential number of this row of the trial list file).
// You can increment this number by 1 and display it in a "You are working on Rule No. X" message.</em>
"episodeNo":0,<em> // the 0-based number of this episode within the series (i.e. among
// the episodes played under a given rule set).
// You can increment this number by 1 and display it as Y in a "Rule No. X, Episode No. Y" message.</em>
"totalRewardEarned":33 <em> // the sum total of rewards earned by this player in all episodes so far</em>
}
</pre>
<p>As of ver. 1.011, in the board description the field <tt>dropped</tt> is shown only in the pieces that have been already removed from the board; the value is the ientifying number (0 thru 3) of the bucket into which the piece has been dropped.</p>


  </li>
  <li>GET <strong><tt>/display</tt>: View the current display:</strong>
      <form method="get" action="game-data/GameService2/display"
	 enctype="application/x-www-form-urlencoded">
	  Episode ID (returned by an earlier newEpisode call): <input name="episode" type="text" size="25"><br>
	  <input type="submit">
      </form>
<p>For the meaning of the output fields, see the documentation for <a href="api/edu/wisc/game/sql/EpisodeInfo.ExtendedDisplay.html">ExtendedDisplay</a>. A field named <tt>foo</tt> will be described there under <tt>getFoo()</tt> or (for boolean values) <tt>isFoo()</tt>.

      
  <p>Sample output (in ver. 1.016). The new fields are ruleSrc and ruleLineNo.
<pre>
  {"bonus":false,
  "totalRewardEarned":0,
  "seriesNo":0,"episodeNo":0,
  "bonusEpisodeNo":0,
  "canActivateBonus":false,
  "totalBoardsPredicted":2,
  "guessSaved":false,
  "rulesSrc":{  <em>// The rules of this game </em>
  "orders":   <em>// array of orders. In this specific game (TD-1) one order is defined, but is not actually used</em>
     ["Order Custom=[36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1]"],
  "rows": <em>// array of rules, one element per line </em>
     ["(1,*,*,*,[0,1,2,3])",
      "(*,*,*,*,[((p + 3) % 4)])"]
  },
  "ruleLineNo":0,  <em>//  which line of the rules set is currently active (0-based)</em>
  "finishCode":0,
  "board":{"id":0,"value":[{"id":1,"color":"RED","shape":"SQUARE","x":6,"y":3,"buckets":[0,1,2,3]},{"id":0,"color":"RED","shape":"SQUARE","x":1,"y":1,"dropped":3,"buckets":[0,1,2,3]}]},
  "code":-8, <em> // It is always -8 on /display calls </em>
  "errmsg":"null\nDEBUG\n*M*[0][20200910-005354-0JVTXF; FC=0; m 1/2 $0]\n[1]\n[2]\nR=$0","numMovesMade":1,
  "transcript":[{"pos":1,"bucketNo":3,"code":0}]
  }
</pre>
      <br>Sample output (in ver. 1.012), extra fields added (some of which pevious were only seen in /newEpisode):
<pre>
  {"board":{"id":0,"value":[{"buckets":[3],"color":"BLUE","dropped":3,"id":0,"shape":"SQUARE","x":5,"y":5}]},
  "code":-8,
   "errmsg":"Display requested\nDEBUG\n[0][20200827-153052-F66ITP; FC=1; M 2/2 $10][20200827-153246-R7LHH9; FC=1; M 3/3 $10]\n[1][20200827-160602-PYQTAJ; FC=1; M 2/2 $10][20200827-162713-2HRENR; FC=1; M 2/2 $10]\n*B*[2][20200905-120700-PDF966; FC=1; M 1/1 $10][20200905-121136-7L3EHY; FC=1; B 1/1 $10]\nR=$60", // <em>just a progress report for this session, handy for debugging </em>
  "finishCode":1,
  "numMovesMade":1,
  "bonus":true,
  "bonusEpisodeNo":0,
  "canActivateBonus":false,
  "episodeNo":1, // <em>sequential number in this series (0-based)</em>
  "guessSaved":false, // <em>has the guess been recorded for this episode?</em>
  "seriesNo":2, // <em>sequential number of this series in the trial list (0-based)</em>
  "totalBoardsPredicted":3, // <em>The current prediction for the total number of episodes to be played in this series.
    // During the main subserties, this is simply para.max_boards; during the bonus subseries, this is A+para.clear_how_many,
    // where A is the number of non-bonus episodes that had been played in this series before bonus was activated.</em>
  "totalRewardEarned":60}
      </pre>
      <br>Sample output (in ver. 1.011)
<pre>
  {"board":{"longId":0,"id":0,"value":
  [{"buckets":[0],"color":"RED","dropped":1,"id":0,"shape":"STAR","x":3,"y":1},
  {"buckets":[0],"color":"RED","dropped":3,"id":0,"shape":"STAR","x":3,"y":5}]},
  "bonus":false,  <em> // true if this episode is part of a bonus subseries</em>
  "code":-8, <em> // It is always -8 on /display calls </em>
  "errmsg":"Display requested", 
  "finishCode":1,<em> // Tells if the episode still continues, has stalemated,
//    has been finished by clearing the board, or has been given up.
//    For the semantics of the <tt>code</tt> and  <tt>finishCode</tt> fields,
//    see the entry on the MOVE command in the <a href="package.html#move">documentation on the Captive Game Server</a></em>
  "numMovesMade":3, <em> // the number of move attempts made so far in this episode</em>
  "totalRewardEarned":0 <em> // the sum total of rewards earned by this player in all episodes so far</em>
  }
</pre>
      
 <li>POST <strong><tt>/move</tt>: Make a move:</strong>
      <form method="post" action="game-data/GameService2/move"
	 enctype="application/x-www-form-urlencoded">
	  Episode ID (returned by an earlier newEpisode call): <input name="episode" type="text" size="25"><br>
	  Piece to move: column=x=<input name="x" type="text" value="1" size="2">,
	  row=y=<input name="y" type="text" value="1" size="2"> (both ranging 1 thru 6)<br>
	  Destination bucket (identified by  bucket_column=bx=<input name="bx" type="text" value="7" size="2">,
	  bucket_row=by=<input name="by" type="text" value="7" size="2"> (possible values are 0 and 7)<br>
	  Attempted move count so far (the number of previous calls to <strong><tt>move</tt></strong> in this episode. This can also be interpreted as 0-based number of this move attempt) <input name="cnt" type="text" value="0" size="5"><br>
	  <input type="submit">
      </form>

   <p>The response structure is nearly identical to that of /move, except that <tt>code</tt> contains a value that describes the accept/deny code to this move.
For the meaning of the output fields, see the documentation for <a href="api/edu/wisc/game/sql/EpisodeInfo.ExtendedDisplay.html">ExtendedDisplay</a>. A field named <tt>foo</tt> will be described there under <tt>getFoo()</tt> or (for boolean values) <tt>isFoo()</tt>.

      
<p>Sample response<pre>
  {"board":{"longId":0,"id":0,"value":
  [{"buckets":[1],"color":"BLUE","id":0,"shape":"TRIANGLE","x":4,"y":2},
  {"buckets":[1],"color":"BLUE","dropped":3,"id":0,"shape":"TRIANGLE","x":2,"y":3}]}, <em> // the board after this move </em>
  "bonus":false, <em> // true if this episode is part of a bonus subseries</em>
  "code":4, <em> Outcome of this move.
    For the semantics of the <tt>code</tt> and  <tt>finishCode</tt> fields,
    see the entry on the MOVE command in the <a href="package.html#move">documentation on the Captive Game Server</a></em>
  "errmsg":"...",<em> // either used to describe errors, or contains various status info for debugging.</em>
  "finishCode":0, <em> Overall state of this episode now.
    For the semantics of the <tt>code</tt> and  <tt>finishCode</tt> fields,
    see the entry on the MOVE command in the <a href="package.html#move">documentation on the Captive Game Server</a></em>
  "numMovesMade":1, <em> // the number of move attempts made so far in this episode</em>
  "totalRewardEarned":42<em> // the sum total of rewards earned by this player in all episodes so far</em>
  }
</pre>

   <p>The finish code reports the current state: 0=can play (there are pieces on the board, and some can be moved), 1=finish (no pieces left on the board), 2=stalemate (there are pieces on the board, but none of them can be moved anymore).</p>
   </li>
 
	<li>POST <strong><tt>/activateBonus:</tt> Activate the bonus for this player. The current episode (if still active) and all subsequent episode of the same series (i.e. played by the same rule) will constitute the "bonus subseries"</strong>
  <form method="post" action="game-data/GameService2/activateBonus"
	 enctype="application/x-www-form-urlencoded">
     <input name="playerId" type="text" size="25" value="AnyText01">
	  <input type="submit">
  </form>
  <br>Sample output
  <pre>
    {"errmsg":"Bonus activated successfully","error":false}
  </pre>
	</li>
   <p>The finish code reports the current state: 0=can play (there are pieces on the board, and some can be moved), 1=finish (no pieces left on the board), 2=stalemate (there are pieces on the board, but none of them can be moved anymore).</p>
   </li>
 
	<li>POST <strong><tt>/giveUp:</tt> "Gives up" the current series (i.e. the series played with the current param set), so that the next episode will be run with the next param set.</strong> If this is invoked while an episode is in progress, the episode will be marked as "given up" as well. However, you may choose to only used this call /at the end of an episode (that is, give the player an option of switching to the next param set for the next episode, regardless of one's current position in the current series).
  <form method="post" action="game-data/GameService2/giveUp"
	 enctype="application/x-www-form-urlencoded">
Player ID:     <input name="playerId" type="text" size="25" value="AnyText01">
Series No.:     <input name="seriesNo" type="text" size="2" value="0">
	  <input type="submit">
  </form>
  <br>The seriesNo value must be exactly the same to which the current (or just completed) episode belongs to, as per the "seriesNo" value obtained in the last /newEpisode call. This is required as a safety check, to ensure that the client and server are on the same page. (If it's an annoyance to have it, I can remove this parameter)
  <br>Sample output (on success):
  <pre>
{"errmsg":"Gave up series 0","error":false}
  </pre>
  </li>
	


 <li>POST <strong><tt>/guess:</tt> Recording a guess</strong>
      <form
        id="wfForm"
        class="wfForm"
	method="post" action="game-data/GameService2/guess"
	enctype="application/x-www-form-urlencoded">

	  Episode ID (returned by an earlier newEpisode call): <input name="episode" type="text" size="25"><br>
	

	<br>
	<textarea id="wf.data" name="data" rows="10" cols="60">
Please type your guess here (an arbitrary test)
	</textarea><br>
	<input type="submit">
      </form>
      <p>
Response (on success):
      <pre>
{"error":false,"byteCnt":91,"path":"/opt/tomcat/saved/guesses/qt-01.csv"}
</pre>

<p>For the meaning of the output fields, see the documentation for <a href="api/edu/wisc/game/rest/GuessWriteReport.html">GuessWriteReport</a>. A field named <tt>foo</tt> will be described there under <tt>getFoo()</tt> or (for boolean values) <tt>isFoo()</tt>.
      
   <p>The response contains a structure, <tt>transitionMap</tt>, which can be used to create a set of button offering the player possible further actions. The structure describes buttons in terms of key/value pairs, where the key tells where you'll get if you click the button, and the value tells how you can get there.
     Listed below  are all possible key/value pairs, and their semantics.

     
     <table border=1>
       <tr><th>Key<th>Value<th>How the button can be labeled <th>What the client can if after player clicks the button

	   <tr><td>MAIN <td> DEFAULT <td>Next episode <td> Call /newEpisode, which will produce another main-subseries (non-bonus) episode in the same series</tr>
	   <tr><td>BONUS <td>DEFAULT <td>Next episode <td> Call /newEpisode, which will produce another bonus episode in the same series</tr>
	   <tr><td>NEXT <td>DEFAULT <td>Next series<td> Call /newEpisode, which will automatically start the first episode of the next series (because no more episodes can be started in the current series)</tr>
	   <tr><td>END <td>DEFAULT<td>Finish<td>The end of the last series, and of the experiment.     Call /newEpisode. It will return error=true, allFinished=true, and completionCode, which the GUI client can then display to the player</tr>
	   
	   <tr><td>BONUS <td> ACTIVATE <td>Activate Bonus<td> Call /activateBonus, followed by /newEpisode (or simply call /newEpisode with activateBonus=true), which will start the first bonus episode in this series</tr>
	   <tr><td>NEXT <td>GIVE_UP <td>Give up (and proceed to the next series) <td> Call /giveUp (which will switch series) followed by /newEpisode.  (Or simply call /newEpisode with giveUp=true). The first episode of the next series will start</tr>
	   <tr><td>END <td>GIVE_UP<td>Give up (and end the last series, and the experiment)<td>Call /newEpisode with giveUp=true. It will return error=true, allFinished=true, and completionCode, which the GUI client can then display to the player. </tr>
     </table>

     <p>A button with value="DEFAULT" is produced after every episode, indicating the default action (continuing in the same series, switching to the next series if the current series is done, or finishing one's work after the last series). A button with value="GIVE_UP" is produced after every episode other than the last episode of a series; it indicates the player's ability to end a series prematurely (and then go to the next series, if available). A button with value="ACTIVATE" is produced after main-subseries episodes if the player is eligibile to switch to ("activate") the bonus subseries.</p>
      
  <li>GET <strong><tt>/debug</tt></strong>: Same info as given by /player, and some more for a specified user:</strong>
        <form method="get" action="game-data/GameService2/debug"
	 enctype="application/x-www-form-urlencoded">
	  Player ID: <input name="playerId" type="text" value="" size="20"><br>
	  <input type="submit">
	</form>
  
  </ol>

<hr>
<h3><a name="html">HTML play (for testing)</a></h3>

<ul>
<li>POST <strong><tt>/mostRecentEpisodeHtml</tt>: Look up the most recent episode for a specified user:</strong>
        <form method="post" action="game-data/GameServiceHtml/mostRecentEpisodeHtml"
	 enctype="application/x-www-form-urlencoded">
	  Player ID: <input name="playerId" type="text" value="" size="20"><br>
	  <input type="submit">
	</form>

<li>POST <strong><tt>/newEpisodeHtml</tt>: Create a new episode for a specified user:</strong>
        <form method="post" action="game-data/GameServiceHtml/newEpisodeHtml"
	 enctype="application/x-www-form-urlencoded">
	  Player ID: <input name="playerId" type="text" value="" size="20"><br>
	  <input type="submit">
	</form>

	
<li>/moveHtml

      <form method="post" action="game-data/GameServiceHtml/moveHtml"
	 enctype="application/x-www-form-urlencoded">
	  Episode ID (returned by an earlier newEpisode call): <input name="episode" type="text" size="25"><br>
	  Piece to move: column=x=<input name="x" type="text" value="1" size="2">,
	  row=y=<input name="y" type="text" value="1" size="2"> (both ranging 1 thru 6)<br>
	  Destination bucket (identified by  bucket_column=bx=<input name="bx" type="text" value="7" size="2">,
	  bucket_row=by=<input name="by" type="text" value="7" size="2"> (possible values are 0 and 7)<br>
	  Attempted move count so far (the number of previous calls to <strong><tt>move</tt></strong> in this episode. This can also be interpreted as 0-based number of this move attempt) <input name="cnt" type="text" value="0" size="5"><br>
	  <input type="submit">
      </form>

</ul>    

<h3>Where are the input files?</h3>

<p>In /opt/tomcat/game-data
  </p>

<h3>Where are the output files?</h3>

<p>In /opt/tomcat/saved
  </p>

				


</body>
</html>
